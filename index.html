<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="./bootstrap/css/bootstrap.css" rel="stylesheet" media="screen" />
<title>KSSMA Card Maker</title>
<style type="text/css">
body {
	padding-top: 40px;
}

.center {
	float: none;
	margin: auto;
}

.well {
	background-color: rgba(245, 245, 245, 0.8);
}

.inputFix {
	width: 100%;
	height: 32px !important;
	text-align: center;
}

</style>
</head>
<body>

<div class="container">

	<div class="row" style="text-align: center;">
	
		<div class="span12">
		
			<div class="well">
				
				<h1>KSSMA Card Maker</h1>
				
				<p>欢迎使用扩散性MA卡片制作工具。本应用为开源项目，托管在<a href="https://github.com/airtheva/kssma-card-maker">GitHub</a>上。关于所使用素材的说明详见README.md。欢迎感兴趣者Fork！</p>
			
				<p>本应用理论上可运行于支持HTML5的Canvas与File API的浏览器，使用Google Chrome浏览器以获得最佳体验。</p>
			
				<p>使用说明：左边有许多的复选框，勾选将在生成图像时绘制该部分。在右边的预览图像中拖动鼠标可以改变图像位置，滚动滚轮可以改变图像缩放倍率，调整完毕后点击左边的保存按钮保存图像。</p>
				
			</div>
		
		</div>
	
	</div>

	<div class="row">
	
		<div class="span3">
			
			<form class="well" action="#">
				<img id="faceCountry-sword" class="hide" src="./resources/face/country/sword.png" />
				<img id="faceCountry-tech" class="hide" src="./resources/face/country/tech.png" />
				<img id="faceCountry-magic" class="hide" src="./resources/face/country/magic.png" />
				<img id="faceCountry-fairy" class="hide" src="./resources/face/country/fairy.png" />
				<img id="faceRarity-5" class="hide" src="./resources/face/rarity/5.png" />
				<img id="faceRarity-6" class="hide" src="./resources/face/rarity/6.png" />
				
				<img id="cardFrame-5" class="hide" src="./resources/card/frame/5.png" />
				<img id="cardFrame-6" class="hide" src="./resources/card/frame/6.png" />
				<img id="cardCountry-sword" class="hide" src="./resources/card/country/sword.png" />
				<img id="cardCountry-tech" class="hide" src="./resources/card/country/tech.png" />
				<img id="cardCountry-magic" class="hide" src="./resources/card/country/magic.png" />
				<img id="cardCountry-fairy" class="hide" src="./resources/card/country/fairy.png" />
				<img id="cardCost-6" class="hide" src="./resources/card/cost/6.png" />
				<img id="cardCost-8" class="hide" src="./resources/card/cost/8.png" />
				<img id="cardCost-9" class="hide" src="./resources/card/cost/9.png" />
				<img id="cardCost-10" class="hide" src="./resources/card/cost/10.png" />
				<img id="cardCost-11" class="hide" src="./resources/card/cost/11.png" />
				<img id="cardCost-12" class="hide" src="./resources/card/cost/12.png" />
				<img id="cardCost-13" class="hide" src="./resources/card/cost/13.png" />
				<img id="cardCost-14" class="hide" src="./resources/card/cost/14.png" />
				<img id="cardCost-15" class="hide" src="./resources/card/cost/15.png" />
				<img id="cardCost-16" class="hide" src="./resources/card/cost/16.png" />
				<img id="cardCost-17" class="hide" src="./resources/card/cost/17.png" />
				<img id="cardCost-18" class="hide" src="./resources/card/cost/18.png" />
				<img id="cardCost-19" class="hide" src="./resources/card/cost/19.png" />
				<img id="cardCost-20" class="hide" src="./resources/card/cost/20.png" />
				<canvas id="nameCache" class="hide"></canvas>
				<label for="file">选择图像：</label><input type="file" id="file" />
				<img id="image" width="100%" />
				<label for="type">类型：</label>
				<select id="type" class="inputFix">
				<option value="0" selected="true">国服 & 台服</option>
				<option value="1">韩服</option>
				</select>
				<label for="faceImageScale">头像图像缩放倍率：</label><input type="text" id="faceImageScale" class="inputFix" value="3.00" />
				<label for="cardImageScale">卡片图像缩放倍率：</label><input type="text" id="cardImageScale" class="inputFix" value="3.00" />
				<label>选择稀有度：</label>
				<label class="radio" for="raritySuperRare"><input type="radio" id="raritySuperRare" name="rarity" value="5" checked="true" />SuperRare</label>
				<label class="radio" for="raritySuperRarePlus"><input type="radio" id="raritySuperRarePlus" name="rarity" value="6" />SuperRare+</label>
				<label>选择阵营：</label>
				<label class="radio" for="countrySword"><input type="radio" id="countrySword" name="country" value="sword" />剑术之城</label>
				<label class="radio" for="countryTech"><input type="radio" id="countryTech" name="country" value="tech" />技巧之场</label>
				<label class="radio" for="countryMagic"><input type="radio" id="countryMagic" name="country" value="magic" />魔法之派</label>
				<label class="radio" for="countryFairy"><input type="radio" id="countryFairy" name="country" value="fairy" checked="true" />妖精</label>
				<label for="cost">选择COST（目前仅支持6，8-20）：<input type="number" id="cost" class="inputFix" name="cost" value="20" /></label>
				<label for="name">名称：</label><input type="text" id="name" class="inputFix" value="奇怪的卡片" checked="true" />
				<button type="button" id="saveFace">保存头像</button>
				<button type="button" id="saveCard">保存卡片</button>
			
			</form>
			
		</div>
	
		<div class="span9">
		
			<div class="well" style="text-align: center;">
			
				<canvas id="face" class="center" width="192" height="192"></canvas>
		
			</div>
		
			<div class="well" style="text-align: center;">
			
				<canvas id="card" class="center" width="640" height="896"></canvas>
		
			</div>
		
		</div>
	
	</div>

</div>

<script type="text/javascript" src="./jquery-2.0.2.min.js"></script>
<script type="text/javascript" src="./bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">

function UpdateNameCache() {
	
	var size = -1;
	var shadowBlur = -1;
	switch($('select#type').val()) {
	case '0':
		size = 15;
		shadowBlur = 1;
		break;
	case '1':
		size = 30;
		shadowBlur = 2;
		break;
	default:
		return;
	}
	
	var name = $('input#name').val();
	
	var canvas = $('canvas#nameCache')[0];
	
	var context = canvas.getContext('2d');
	
	context.font = 'bold ' + size + 'px arial';
	context.fillStyle = '#ffffff';
	var measure = context.measureText(name);
	
	canvas.width = measure.width + 2;
	
	var context = canvas.getContext('2d');
	
	context.font = 'bold ' + size + 'px arial';
	
	context.shadowColor = '#000000';
	context.shadowBlur = shadowBlur;
	
	context.fillStyle = '#000000';
	context.fillText(name, 0, size);
	context.fillText(name, 1, size);
	context.fillText(name, 2, size);
	context.fillText(name, 0, size + 1);
	context.fillText(name, 1, size + 1);
	context.fillText(name, 2, size + 1);
	context.fillText(name, 0, size + 2);
	context.fillText(name, 1, size + 2);
	context.fillText(name, 2, size + 2);
	
	context.fillStyle = '#ffffff';
	context.fillText(name, 1, size + 1);
	
	//context.fillText(name, 320 - measure.width / 2, 18 + 30);
	//context.fillText(name, 320 - measure.width / 2, 18 + 30 - 1);
	//context.fillText(name, 320 - measure.width / 2 + 1, 18 + 30 - 1);
	//context.fillText(name, 320 - measure.width / 2 + 1, 18 + 30);
	
};

var FaceCanvas = {};

FaceCanvas.isMouseDown = false;
FaceCanvas.lastOffsetX = 0;
FaceCanvas.lastOffsetY = 0;

FaceCanvas.TranslateX = 0;
FaceCanvas.TranslateY = 0;

FaceCanvas.OnMouseDown = function(event) {
	
	FaceCanvas.isMouseDown = true;
	
};

FaceCanvas.OnMouseMove = function(event) {
	
	//console.log(event);
	
	if(FaceCanvas.isMouseDown) {
		
		FaceCanvas.TranslateX += event.offsetX - FaceCanvas.lastOffsetX;
		FaceCanvas.TranslateY += event.offsetY - FaceCanvas.lastOffsetY;
		
	}
	
	FaceCanvas.lastOffsetX = event.offsetX;
	FaceCanvas.lastOffsetY = event.offsetY;
	
};

FaceCanvas.OnMouseUp = function(event) {
	
	FaceCanvas.isMouseDown = false;
	
};

FaceCanvas.OnMouseWheel = function(event) {
	
	var $scale = $('input#faceImageScale');

	// toFixed() is a fix for parseFloat().
	
	if(event.wheelDelta === 120) {
		
		$scale.val((parseFloat($scale.val(), 10) + 0.1).toFixed(2));
		
	}
	
	if(event.wheelDelta === -120) {
		
		$scale.val((parseFloat($scale.val(), 10) - 0.1).toFixed(2));
		
	}
	
	// Prevent page scrolling.
	event.preventDefault(); // Works in Chrome.
	
};

FaceCanvas.Reset = function() {

	FaceCanvas.TranslateX = 0;
	FaceCanvas.TranslateY = 0;
	
};

FaceCanvas.Update = function() {
	
	var scale = parseFloat($('input#faceImageScale').val(), 10);
	
	var canvas = $('canvas#face')[0].getContext('2d');
	
	canvas.fillStyle = 'rgba(255, 255, 255, 1.0)';
	canvas.fillRect(0, 0, 192, 192);
	
	var image = $('#image')[0];
	canvas.drawImage(image, FaceCanvas.TranslateX, FaceCanvas.TranslateY, image.width * scale, image.height * scale);

	var rarity = $('input[name="rarity"]:checked').val();
	canvas.drawImage($('img#faceRarity-' + rarity)[0], 0, 0);

	var country = $('input[name="country"]:checked').val();
	canvas.drawImage($('img#faceCountry-' + country)[0], 0, 0);

};

var CardCanvas = {};

CardCanvas.isMouseDown = false;
CardCanvas.lastOffsetX = 0;
CardCanvas.lastOffsetY = 0;

CardCanvas.TranslateX = 0;
CardCanvas.TranslateY = 0;

CardCanvas.OnMouseDown = function(event) {
	
	CardCanvas.isMouseDown = true;
	
};

CardCanvas.OnMouseMove = function(event) {
	
	//console.log(event);
	
	if(CardCanvas.isMouseDown) {
		
		CardCanvas.TranslateX += event.offsetX - CardCanvas.lastOffsetX;
		CardCanvas.TranslateY += event.offsetY - CardCanvas.lastOffsetY;
		
	}
	
	CardCanvas.lastOffsetX = event.offsetX;
	CardCanvas.lastOffsetY = event.offsetY;
	
};

CardCanvas.OnMouseUp = function(event) {
	
	CardCanvas.isMouseDown = false;
	
};

CardCanvas.OnMouseWheel = function(event) {
	
	var $scale = $('input#cardImageScale');

	// toFixed() is a fix for parseFloat().
	
	if(event.wheelDelta === 120) {
		
		$scale.val((parseFloat($scale.val(), 10) + 0.1).toFixed(2));
		
	}
	
	if(event.wheelDelta === -120) {
		
		$scale.val((parseFloat($scale.val(), 10) - 0.1).toFixed(2));
		
	}
	
	// Prevent page scrolling.
	event.preventDefault(); // Works in Chrome.
	
};

CardCanvas.Reset = function() {

	CardCanvas.TranslateX = 0;
	CardCanvas.TranslateY = 0;
	
};

CardCanvas.Update = function() {
	
	var width = -1;
	var height = -1;
	var nameTop = -1;
	switch($('select#type').val()) {
	case '0':
		width = 308;
		height = 434;
		nameTop = 6;
		break;
	case '1':
		width = 640;
		height = 896;
		nameTop = 14;
		break;
	default:
		return;
	}
	
	var scale = parseFloat($('input#cardImageScale').val(), 10);
	
	var canvas = $('canvas#card')[0];
	canvas.width = width;
	canvas.height = height;
	
	var context = canvas.getContext('2d');
	
	context.fillStyle = 'rgba(255, 255, 255, 1.0)';
	context.fillRect(0, 0, width, height);
	
	var image = $('#image')[0];
	context.drawImage(image, CardCanvas.TranslateX, CardCanvas.TranslateY, image.width * scale, image.height * scale);

	var rarity = $('input[name="rarity"]:checked').val();
	context.drawImage($('img#cardFrame-' + rarity)[0], 0, 0, width, height);

	var country = $('input[name="country"]:checked').val();
	context.drawImage($('img#cardCountry-' + country)[0], 0, 0, width, height);

	var cost = $('input#cost').val();
	context.drawImage($('img#cardCost-' + cost)[0], 0, 0, width, height);

	var nameCache = $('canvas#nameCache')[0];
	context.drawImage(nameCache, width / 2 - nameCache.width / 2, nameTop);
	
};

$(document).ready(function() {
	
	$('input#file').change(function(event) {
		
		var fileReader = new FileReader();
		fileReader.onload = function(event) {
			$('img#image')[0].src = event.target.result;
			FaceCanvas.Reset();
			CardCanvas.Reset();
		};
		fileReader.readAsDataURL(this.files[0]);
		
	});
	
	$('button#saveFace').click(function(event) {
		
		var face = $('canvas#face')[0];
		
		window.open(face.toDataURL('image/png'));
		
	});
	
	$('button#saveCard').click(function(event) {
		
		var face = $('canvas#face')[0];
		
		window.open(card.toDataURL('image/png'));
		
	});
	
	$('canvas#face').mousedown(FaceCanvas.OnMouseDown);
	
	$('canvas#face').mousemove(FaceCanvas.OnMouseMove);
	
	$('canvas#face').mouseup(FaceCanvas.OnMouseUp);
		
	$('canvas#face')[0].onmousewheel = FaceCanvas.OnMouseWheel;

	setInterval(FaceCanvas.Update, 30);
	
	$('canvas#card').mousedown(CardCanvas.OnMouseDown);
	
	$('canvas#card').mousemove(CardCanvas.OnMouseMove);
	
	$('canvas#card').mouseup(CardCanvas.OnMouseUp);
		
	$('canvas#card')[0].onmousewheel = CardCanvas.OnMouseWheel;

	setInterval(UpdateNameCache, 1000);
	
	setInterval(CardCanvas.Update, 30);
	
});

</script>
</body>
</html>