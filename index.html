<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="./bootstrap/css/bootstrap.css" rel="stylesheet" media="screen" />
<title>KSSMA Card Maker</title>
<style type="text/css">
body {
	padding-top: 40px;
}

.center {
	float: none;
	margin: auto;
}

.well {
	background-color: rgba(245, 245, 245, 0.8);
}
</style>
</head>
<body>

<div class="container">

	<div class="row" style="text-align: center;">
	
		<div class="span12">
		
			<div class="well">
			
				<h1>KSSMA Card Maker</h1>
				
				<p>欢迎使用扩散性MA卡片制作工具。本应用为开源项目，托管在<a href="https://github.com/airtheva/kssma-card-maker">GitHub</a>上。关于所使用素材的说明详见README.md。欢迎感兴趣者Fork！</p>
			
				<p>使用说明：左边有许多的复选框，勾选将在生成图像时绘制该部分。在右边的预览图像中拖动鼠标可以改变图像位置，滚动滚轮可以改变图像缩放倍率，调整完毕后点击左边的保存按钮保存图像。</p>
			
			</div>
		
		</div>
	
	</div>

	<div class="row">
	
		<div class="span3">
			
			<form class="well" action="#">
			
				<img id="sword" class="hide" src="./sword.png" />
				<img id="skill" class="hide" src="./skill.png" />
				<img id="magic" class="hide" src="./magic.png" />
				<img id="fairy" class="hide" src="./fairy.png" />
				<img id="superRare" class="hide" src="./superRare.png" />
				<img id="superRarePlus" class="hide" src="./superRarePlus.png" />
				<label for="file">选择图像：</label><input type="file" id="file" />
				<img id="image" width="100%" />
				<label for="scale">图像缩放倍率：</label><input type="text" id="scale" value="1.00" style="width: 100%; height: 32px; text-align: center;" />
				<label class="checkbox" for="isImageShowed"><input type="checkbox" id="isImageShowed" />显示图像</label>
				<label class="checkbox" for="isFrameShowed"><input type="checkbox" id="isFrameShowed" />显示边框</label>
				<label class="radio" for="frameSuperRare"><input type="radio" id="frameSuperRare" name="frame" checked="true" />SuperRare</label>
				<label class="radio" for="frameSuperRarePlus"><input type="radio" id="frameSuperRarePlus" name="frame" />SuperRare+</label>
				<label class="checkbox" for="isCountryShowed"><input type="checkbox" id="isCountryShowed" />显示阵营</label>
				<label class="radio" for="countrySword"><input type="radio" id="countrySword" name="country" />剑城</label>
				<label class="radio" for="countrySkill"><input type="radio" id="countrySkill" name="country" />技场</label>
				<label class="radio" for="countryMagic"><input type="radio" id="countryMagic" name="country" />魔派</label>
				<label class="radio" for="countryFairy"><input type="radio" id="countryFairy" name="country" checked="true" />妖精</label>
				<label class="checkbox" for="isNameShowed"><input type="checkbox" id="isNameShowed" />显示名称</label>
				<label for="name">名称：</label><input type="text" id="name" value="奇怪的卡片" style="width: 100%; height: 32px; text-align: center;" />
				<button type="button" id="save">保存</button>
			
			</form>
			
		</div>
	
		<div class="span9">
		
			<div class="well" style="text-align: center;">
			
			<canvas id="canvas" class="center" width="640" height="896"></canvas>
		
			</div>
		
		</div>
	
	</div>

</div>

<script type="text/javascript" src="./jquery-2.0.2.min.js"></script>
<script type="text/javascript" src="./bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">

var Canvas = {};

Canvas.isMouseDown = false;
Canvas.lastOffsetX = 0;
Canvas.lastOffsetY = 0;

Canvas.TranslateX = 0;
Canvas.TranslateY = 0;

Canvas.OnMouseDown = function(event) {
	
	Canvas.isMouseDown = true;
	
};

Canvas.OnMouseMove = function(event) {
	
	//console.log(event);
	
	if(Canvas.isMouseDown) {
		
		Canvas.TranslateX += event.offsetX - Canvas.lastOffsetX;
		Canvas.TranslateY += event.offsetY - Canvas.lastOffsetY;
		
	}
	
	Canvas.lastOffsetX = event.offsetX;
	Canvas.lastOffsetY = event.offsetY;
	
};

Canvas.OnMouseUp = function(event) {
	
	Canvas.isMouseDown = false;
	
};

Canvas.OnMouseWheel = function(event) {
	
	var $scale = $('input#scale');

	// toFixed() is a fix for parseFloat().
	
	if(event.wheelDelta === 120) {
		
		$scale.val((parseFloat($scale.val(), 10) + 0.1).toFixed(2));
		
	}
	
	if(event.wheelDelta === -120) {
		
		$scale.val((parseFloat($scale.val(), 10) - 0.1).toFixed(2));
		
	}
	
	// Prevent page scrolling.
	event.preventDefault(); // Works in Chrome.
	
};

Canvas.Reset = function() {

	Canvas.TranslateX = 0;
	Canvas.TranslateY = 0;
	
};

Canvas.Preview = function() {
	
	var scale = parseFloat($('input#scale').val(), 10);
	
	var canvas = $('#canvas')[0].getContext('2d');
	
	canvas.fillStyle = 'rgba(255, 255, 255, 1.0)';
	canvas.fillRect(0, 0, 640, 896);
	
	if($('input#isImageShowed').prop('checked') === true) {
		var image = $('#image')[0];
		canvas.drawImage(image, Canvas.TranslateX, Canvas.TranslateY, image.width * scale, image.height * scale);
	}
	
	if($('input#isFrameShowed').prop('checked') === true) {
		if($('input#frameSuperRare').prop('checked') === true) {
			canvas.drawImage($('img#superRare')[0], 0, 0);
		}
		if($('input#frameSuperRarePlus').prop('checked') === true) {
			canvas.drawImage($('img#superRarePlus')[0], 0, 0);
		}
	}
	
	if($('input#isCountryShowed').prop('checked') === true) {
		if($('input#countrySword').prop('checked') === true) {
			canvas.drawImage($('img#sword')[0], 0, 0);
		}
		if($('input#countrySkill').prop('checked') === true) {
			canvas.drawImage($('img#skill')[0], 0, 0);
		}
		if($('input#countryMagic').prop('checked') === true) {
			canvas.drawImage($('img#magic')[0], 0, 0);
		}
		if($('input#countryFairy').prop('checked') === true) {
			canvas.drawImage($('img#fairy')[0], 0, 0);
		}
	}
	
	if($('input#isNameShowed').prop('checked') === true) {
		
		var name = $('input#name').val();
		
		canvas.font = 'bold 30px arial';
		canvas.fillStyle = '#ffffff';
		canvas.shadowColor = '#000000';
		canvas.shadowBlur = 5;
		var measure = canvas.measureText(name);
		canvas.fillText(name, 320 - measure.width / 2, 18 + 30);
		canvas.fillText(name, 320 - measure.width / 2, 18 + 30 - 1);
		canvas.fillText(name, 320 - measure.width / 2 + 1, 18 + 30 - 1);
		canvas.fillText(name, 320 - measure.width / 2 + 1, 18 + 30);
		
	}
	
};

$(document).ready(function() {
	
	$('input#file').change(function(event) {
		
		var fileReader = new FileReader();
		fileReader.onload = function(event) {
			$('#image')[0].src = event.target.result;
			Canvas.Reset();
		};
		fileReader.readAsDataURL(this.files[0]);
		
	});
	
	$('button#save').click(function(event) {
		
		var canvas = $('#canvas')[0];
		
		window.open(canvas.toDataURL('image/png'));
		
	});
	
	$('#canvas').mousedown(Canvas.OnMouseDown);
	
	$('#canvas').mousemove(Canvas.OnMouseMove);
	
	$('#canvas').mouseup(Canvas.OnMouseUp);
		
	$('#canvas')[0].onmousewheel = Canvas.OnMouseWheel;

	setInterval(Canvas.Preview, 30);
	
});

</script>
</body>
</html>