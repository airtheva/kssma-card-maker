<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="./bootstrap/css/bootstrap.css" rel="stylesheet" media="screen" />
<title>KSSMA Card Maker</title>
<style type="text/css">
body {
	padding-top: 40px;
}

.center {
	float: none;
	margin: auto;
}

.well {
	background-color: rgba(245, 245, 245, 0.8);
}

.inputFix {
	width: 100%;
	height: 32px !important;
	text-align: center;
}

</style>
</head>
<body>

<div class="container">

	<div class="row" style="text-align: center;">
	
		<div class="span12">
		
			<div class="well">
			
				<h1>KSSMA Card Maker</h1>
				
				<p>欢迎使用扩散性MA卡片制作工具。本应用为开源项目，托管在<a href="https://github.com/airtheva/kssma-card-maker">GitHub</a>上。关于所使用素材的说明详见README.md。欢迎感兴趣者Fork！</p>
			
				<p>本应用理论上可运行于支持HTML5的Canvas与File API的浏览器，使用Google Chrome浏览器以获得最佳体验。</p>
			
				<p>使用说明：左边有许多的复选框，勾选将在生成图像时绘制该部分。在右边的预览图像中拖动鼠标可以改变图像位置，滚动滚轮可以改变图像缩放倍率，调整完毕后点击左边的保存按钮保存图像。</p>
				
			</div>
		
		</div>
	
	</div>

	<div class="row">
	
		<div class="span3">
			
			<form class="well" action="#">
			
				<img id="superRare" class="hide" src="./resources/rarity/superRare.png" />
				<img id="superRarePlus" class="hide" src="./resources/rarity/superRarePlus.png" />
				<img id="sword" class="hide" src="./resources/country/sword.png" />
				<img id="tech" class="hide" src="./resources/country/tech.png" />
				<img id="magic" class="hide" src="./resources/country/magic.png" />
				<img id="fairy" class="hide" src="./resources/country/fairy.png" />
				<img id="6" class="hide" src="./resources/cost/6.png" />
				<img id="8" class="hide" src="./resources/cost/8.png" />
				<img id="9" class="hide" src="./resources/cost/9.png" />
				<img id="10" class="hide" src="./resources/cost/10.png" />
				<img id="11" class="hide" src="./resources/cost/11.png" />
				<img id="12" class="hide" src="./resources/cost/12.png" />
				<img id="13" class="hide" src="./resources/cost/13.png" />
				<img id="14" class="hide" src="./resources/cost/14.png" />
				<img id="15" class="hide" src="./resources/cost/15.png" />
				<img id="16" class="hide" src="./resources/cost/16.png" />
				<img id="17" class="hide" src="./resources/cost/17.png" />
				<img id="18" class="hide" src="./resources/cost/18.png" />
				<img id="19" class="hide" src="./resources/cost/19.png" />
				<img id="20" class="hide" src="./resources/cost/20.png" />
				<canvas id="nameCache" class="hide"></canvas>
				<label for="file">选择图像：</label><input type="file" id="file" />
				<img id="image" width="100%" />
				<label for="scale">图像缩放倍率：</label><input type="text" id="scale" class="inputFix" value="1.00" />
				<label class="checkbox" for="isImageShowed"><input type="checkbox" id="isImageShowed" checked="true" />显示图像</label>
				<label class="checkbox" for="isFrameShowed"><input type="checkbox" id="isFrameShowed" checked="true" />显示边框</label>
				<label class="radio" for="frameSuperRare"><input type="radio" id="frameSuperRare" name="frame" value="superRare" checked="true" />SuperRare</label>
				<label class="radio" for="frameSuperRarePlus"><input type="radio" id="frameSuperRarePlus" name="frame" value="superRarePlus" />SuperRare+</label>
				<label class="checkbox" for="isCountryShowed"><input type="checkbox" id="isCountryShowed" checked="true" />显示阵营</label>
				<label class="radio" for="countrySword"><input type="radio" id="countrySword" name="country" value="sword" />剑术之城</label>
				<label class="radio" for="countryTech"><input type="radio" id="countryTech" name="country" value="tech" />技巧之场</label>
				<label class="radio" for="countryMagic"><input type="radio" id="countryMagic" name="country" value="magic" />魔法之派</label>
				<label class="radio" for="countryFairy"><input type="radio" id="countryFairy" name="country" value="fairy" checked="true" />妖精</label>
				<label class="checkbox" for="isCostShowed"><input type="checkbox" id="isCostShowed" checked="true" />显示COST</label>
				<label for="cost">COST（目前仅支持6，8-20）：<input type="number" id="cost" class="inputFix" name="cost" value="20" /></label>
				<label class="checkbox" for="isNameShowed"><input type="checkbox" id="isNameShowed" checked="true" />显示名称</label>
				<label for="name">名称：</label><input type="text" id="name" class="inputFix" value="奇怪的卡片" checked="true" />
				<button type="button" id="save">保存</button>
			
			</form>
			
		</div>
	
		<div class="span9">
		
			<div class="well" style="text-align: center;">
			
			<canvas id="canvas" class="center" width="640" height="896"></canvas>
		
			</div>
		
		</div>
	
	</div>

</div>

<script type="text/javascript" src="./jquery-2.0.2.min.js"></script>
<script type="text/javascript" src="./bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript">

function UpdateNameCache() {
	
	var name = $('input#name').val();
	
	var canvas = $('canvas#nameCache')[0];
	
	var context = canvas.getContext('2d');
	
	context.font = 'bold 30px arial';
	context.fillStyle = '#ffffff';
	var measure = context.measureText(name);
	
	canvas.width = measure.width + 2;
	
	var context = canvas.getContext('2d');
	
	context.font = 'bold 30px arial';
	
	context.shadowColor = '#000000';
	context.shadowBlur = 2;
	
	context.fillStyle = '#000000';
	context.fillText(name, 0, 30);
	context.fillText(name, 1, 30);
	context.fillText(name, 2, 30);
	context.fillText(name, 0, 31);
	context.fillText(name, 1, 31);
	context.fillText(name, 2, 31);
	context.fillText(name, 0, 32);
	context.fillText(name, 1, 32);
	context.fillText(name, 2, 32);
	
	context.fillStyle = '#ffffff';
	context.fillText(name, 1, 31);
	
	//context.fillText(name, 320 - measure.width / 2, 18 + 30);
	//context.fillText(name, 320 - measure.width / 2, 18 + 30 - 1);
	//context.fillText(name, 320 - measure.width / 2 + 1, 18 + 30 - 1);
	//context.fillText(name, 320 - measure.width / 2 + 1, 18 + 30);
	
};

var Canvas = {};

Canvas.isMouseDown = false;
Canvas.lastOffsetX = 0;
Canvas.lastOffsetY = 0;

Canvas.TranslateX = 0;
Canvas.TranslateY = 0;

Canvas.OnMouseDown = function(event) {
	
	Canvas.isMouseDown = true;
	
};

Canvas.OnMouseMove = function(event) {
	
	//console.log(event);
	
	if(Canvas.isMouseDown) {
		
		Canvas.TranslateX += event.offsetX - Canvas.lastOffsetX;
		Canvas.TranslateY += event.offsetY - Canvas.lastOffsetY;
		
	}
	
	Canvas.lastOffsetX = event.offsetX;
	Canvas.lastOffsetY = event.offsetY;
	
};

Canvas.OnMouseUp = function(event) {
	
	Canvas.isMouseDown = false;
	
};

Canvas.OnMouseWheel = function(event) {
	
	var $scale = $('input#scale');

	// toFixed() is a fix for parseFloat().
	
	if(event.wheelDelta === 120) {
		
		$scale.val((parseFloat($scale.val(), 10) + 0.1).toFixed(2));
		
	}
	
	if(event.wheelDelta === -120) {
		
		$scale.val((parseFloat($scale.val(), 10) - 0.1).toFixed(2));
		
	}
	
	// Prevent page scrolling.
	event.preventDefault(); // Works in Chrome.
	
};

Canvas.Reset = function() {

	Canvas.TranslateX = 0;
	Canvas.TranslateY = 0;
	
};

Canvas.Update = function() {
	
	var scale = parseFloat($('input#scale').val(), 10);
	
	var canvas = $('#canvas')[0].getContext('2d');
	
	canvas.fillStyle = 'rgba(255, 255, 255, 1.0)';
	canvas.fillRect(0, 0, 640, 896);
	
	if($('input#isImageShowed').prop('checked') === true) {
		var image = $('#image')[0];
		canvas.drawImage(image, Canvas.TranslateX, Canvas.TranslateY, image.width * scale, image.height * scale);
	}
	
	if($('input#isFrameShowed').prop('checked') === true) {
		var frame = $('input[name="frame"]:checked').val();
		canvas.drawImage($('img#' + frame)[0], 0, 0);
	}
	
	if($('input#isCountryShowed').prop('checked') === true) {
		var country = $('input[name="country"]:checked').val();
		canvas.drawImage($('img#' + country)[0], 0, 0);
	}
	
	if($('input#isCostShowed').prop('checked') === true) {
		var cost = $('input#cost').val();
		canvas.drawImage($('img#' + cost)[0], 0, 0);
	}
	
	if($('input#isNameShowed').prop('checked') === true) {
		
		var nameCache = $('canvas#nameCache')[0];
		
		canvas.drawImage(nameCache, 320 - nameCache.width / 2, 15);
		
	}
	
};

$(document).ready(function() {
	
	$('input#file').change(function(event) {
		
		var fileReader = new FileReader();
		fileReader.onload = function(event) {
			$('img#image')[0].src = event.target.result;
			Canvas.Reset();
		};
		fileReader.readAsDataURL(this.files[0]);
		
	});
	
	$('button#save').click(function(event) {
		
		var canvas = $('canvas#canvas')[0];
		
		window.open(canvas.toDataURL('image/png'));
		
	});
	
	$('#canvas').mousedown(Canvas.OnMouseDown);
	
	$('#canvas').mousemove(Canvas.OnMouseMove);
	
	$('#canvas').mouseup(Canvas.OnMouseUp);
		
	$('#canvas')[0].onmousewheel = Canvas.OnMouseWheel;

	setInterval(UpdateNameCache, 1000);
	
	setInterval(Canvas.Update, 30);
	
});

</script>
</body>
</html>